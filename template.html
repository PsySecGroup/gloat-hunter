<html>
<head></head>
<body>
  <style>
    html, body {
      margin: 0;
      font-family:  Arial;
    }
    .vTop {
      vertical-align: top;
    }
    .smallText {
      font-size: 11px;
    }
    .primaryBackground {
      background:linear-gradient(rgb(120, 146, 194), #476e9e);
    }
    #results {
      border: 1px solid #FFFFFF;
      text-align: center;
      border-collapse: collapse;
    }
    #results td, table th {
      border: 1px solid #FFFFFF;
      padding:  1em;
    }
    #results tbody td {
      font-size: 15px;
    }
    #results tr:nth-child(even) {
      background: #D0E4F5;
    }
    #results thead {
      background:linear-gradient(rgb(120, 146, 194), #476e9e);
      border-bottom: 5px solid #FFFFFF;
    }
    #results thead th {
      font-size: 25px;
      font-weight: bold;
      color: #FFFFFF;
      text-align: center;
      border-left: 2px solid #FFFFFF;: 1em;
    }
    #results thead th:first-child {
      border-left: none;
    }
    #results tfoot {
      font-size: 14px;
      font-weight: bold;
      color: #333333;
      background: #D0E4F5;
      border-top: 3px solid #444444;
    }
    #results tfoot td {
      font-size: 14px;
    }
    .highlight {
      padding: 3px;
      background: yellow;
      font-weight: bold;
      font-style: italic;
      border: #888 solid 1px;
    }

    #hours {
      width: 100%;
      border-collapse: collapse;
      border: 1px solid black;
    }

    #hours td {
      border: 0px solid black;
      padding: 10px;
      position: relative;
    }

    #bars {
      height: 230px;
    }

    .bar {
      width: 20px;
      background-color: #D45F5F;
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
    }
    
    .button {
      margin-top: 1em;
      padding: 1em;
      font-size:15px;
      font-family:Arial;
      width:140px;
      height:50px;
      border-width:1px;
      color:#fff;
      border-color:#4e6096;
      border-top-left-radius:10px;
      border-top-right-radius:10px;
      border-bottom-left-radius:10px;
      border-bottom-right-radius:10px;
      box-shadow: 0px 0px 0px 2px #9fb4f2;
      text-shadow: 0px 1px 0px #283966;
      background:linear-gradient(rgb(120, 146, 194), #476e9e);
      text-decoration: none;
    }

    .button:hover {
      background: linear-gradient(#476e9e, rgb(120, 146, 194));
    }

    .tabs {
      justify-content: center;
      display: flex;
      width: 100%;
      margin: 0;
      background-color: #FBEBD2;
    }

    .tab {
      padding: 0px 20px;
      cursor: pointer;
    }

    .tab.active {
      border-bottom: orange solid 5px;
    }

    .tab-content {
      text-align: -webkit-center;
      display: none;
      padding: 20px;
    }

    .tab-content.active {
      display: block;
    }

    #search {
      font-size: 1.5em;
      padding: 10px;
    }

    /* Tooltip container */
    #queryHelp {
      background-color: #FBEBD2;
      text-align: left;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 400px;
      padding:  1em;
      border: 1px solid #000;
      background-color: #fff;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    #queryHelp.visible {
      opacity: 1;
    }
  </style>
  <div>
    <div class="tabs">
      <div class="tab active" onclick="changeTab(0)"><h4>Offline Search</h4></div>
      <div class="tab" onclick="changeTab(1)"><h4>Sleep Analysis</h4></div>
      <div class="tab" onclick="changeTab(2)"><h4>Group Chat</h4></div>
      <div class="tab" onclick="changeTab(3)"><h4>Bounty System</h4></div>
    </div>
    <div class="tab-content active">
      <input id="search" type="text" placeholder="Search here..."/>
      <a href="#" class="button" id="queryHelpButton">
        ?
      </a>
      <div id="queryHelp">
        <h3>Query Options</h3>
        <ul>
          <li><b>basket</b> finds anything that starts with 'basket' (Like '<b>basket</b>ball and <b>basket</b>weaving)</li>
          <li><b>basket or glove</b> will find anything that starts 'basket' or 'glove'</li>
          <li><b>'basket'</b> (with quotes) will only find anything that is the word 'basket'</li>
        </ul>
      </div>
      <br/><br/>
      <table id="results"></table>
    </div>
    <div class="tab-content" id="sleepAnalysis"></div>
    <div class="tab-content" id="jitsi">
      <span id="loadingJitsi">Loading...</span>
    </div>
    <div class="tab-content" id="bounty">
      <span id="loadingBounty">Coming soon!</span>
    </div>
  </div>
  <div>
  </div>
  <script>
    let api
    let peers
    const domain = 'meet.jit.si';
    const options = {
roomName: '{{jitsi}}',
      width: '50%',
      height: '50%',
      parentNode: document.querySelector('#jitsi'),
      lang: 'en'
    };

    // Create CSV array
    const csv = `
{{replaceMe}}
    `.split('\n').map(line => {
      line = line.trim()
      if (line === '') {
        return
      }

      const parts = line.split('\t')
      return [new Date(parts[0]), (parts[1] || '').toLowerCase()]
    })

    let searchTimeout
    const quotes = /'|"/g
    const removeUsers = /\@[^\s\n]+/g
    const removeHash = /\#[^\s\n]+/g

    const queryHelpButton = document.getElementById('queryHelpButton');
    const queryHelp = document.getElementById('queryHelp');

    queryHelpButton.addEventListener('mouseover', () => {
      queryHelp.classList.add('visible');
    });

    queryHelpButton.addEventListener('mouseout', () => {
      queryHelp.classList.remove('visible');
    });

    /**
     * 
     */
    function createIndex (csv) {
      const result = {}
      let i = 0

      for (const tweet of csv) {
        if (tweet === undefined) {
          i += 1
          continue
        }
        const words = tweet[1].split(/\b/)

        // Iterate through each word
        words.forEach(word => {
          if (word.trim() !== '') {
            // Check if word already exists in the index
            if (result[word]) {
              result[word].push(i);
            } else {
              result[word] = [i];
            }
          }
        });

        i += 1
      }

      return result
    }

    const timezones = {
      "UTC-12:00": "Baker Island",
      "UTC-11:00": "Niue",
      "UTC-10:00": "Hawaii-Aleutian",
      "UTC-09:00": "Alaska",
      "UTC-08:00": "Pacific US",
      "UTC-07:00": "Mountain US",
      "UTC-06:00": "Central US",
      "UTC-05:00": "Eastern US",
      "UTC-04:00": "Atlantic US",
      "UTC-03:00": "Fernando de Noronha",
      "UTC-02:00": "South Georgia",
      "UTC-01:00": "Azores",
      "UTC±00:00": "Greenwich",
      "UTC+01:00": "Central European",
      "UTC+02:00": "Eastern European",
      "UTC+03:00": "Moscow",
      "UTC+04:00": "Gulf",
      "UTC+05:00": "Pakistan",
      "UTC+06:00": "Bangladesh",
      "UTC+07:00": "Indochina",
      "UTC+08:00": "China",
      "UTC+09:00": "Japan",
      "UTC+10:00": "Australian",
      "UTC+11:00": "Solomon Islands",
      "UTC+12:00": "New Zealand",
    }

    /**
     * 
     */
    function loadScript(url, callback) {
      var script = document.createElement('script');
      script.src = url;

      // Execute the callback function after the script is loaded
      script.onload = callback;

      // Append the script element to the document
      document.head.appendChild(script);
    }

    /**
     * 
     */
    function changeTab(tabIndex) {
      var tabs = document.getElementsByClassName("tab");
      var tabContents = document.getElementsByClassName("tab-content");

      // Remove "active" class from all tabs and tab contents
      for (var i = 0; i < tabs.length; i++) {
        tabs[i].classList.remove("active");
        tabContents[i].classList.remove("active");
      }

      // Add "active" class to the clicked tab and corresponding tab content
      tabs[tabIndex].classList.add("active");
      tabContents[tabIndex].classList.add("active");

      if (tabIndex === 2) {
        loadGroupChat()
      } else if (tabIndex === 3) {
        loadBountySystem()
      }
    }

    /**
     * 
     */
    function loadBountySystem() {
      if (api === undefined) {
        loadScript('https://cdnjs.cloudflare.com/ajax/libs/simple-peer/9.7.0/simplepeer.min.js', () => {
          console.log('loaded')
          peers = new SimplePeer({
            initiator: false,
            trickle: false,
            config: {
              iceServers: [
                { urls: 'stun:relay.webwormhole.io:3478' },
                { urls: 'stun:stun.nextcloud.com:443' },
                { urls: 'stun:stun1.l.google.com:19302' },
                { urls: 'stun:stun2.l.google.com:19302' },
                { urls: 'stun:stun3.l.google.com:19302' },
                { urls: 'stun:stun4.l.google.com:19302' },
              ]
            },
          })

          // @TODO figure this out!
          peers.on('error', console.error)

          peers.on('signal', data => {
            console.log('SIGNAL', data)
            peers.signal(data)
          })

          peers.on('connect', () => {
            console.log('CONNECT')
            peers.send('whatever' + Math.random())
          })

          peers.on('data', data => {
            console.log('data: ' + data)
          })

          //document.getElementById('loadingBounty').remove()
        })
      }
    }

    /**
     * 
     */
    function loadGroupChat() {
      if (api === undefined) {
        loadScript('https://meet.jit.si/external_api.js', () => {
          api = new JitsiMeetExternalAPI(domain, options);
          document.getElementById('loadingJitsi').remove()
        })
      }
    }

    /**
     * 
     */
    function getSuggestedTimezone(utcHour) {
      const timezoneNames = [
        "UTC-12:00", "UTC-11:00", "UTC-10:00", "UTC-09:00", "UTC-08:00", "UTC-07:00",
        "UTC-06:00", "UTC-05:00", "UTC-04:00", "UTC-03:00", "UTC-02:00", "UTC-01:00",
        "UTC±00:00", "UTC+01:00", "UTC+02:00", "UTC+03:00", "UTC+04:00", "UTC+05:00",
        "UTC+06:00", "UTC+07:00", "UTC+08:00", "UTC+09:00", "UTC+10:00", "UTC+11:00"
      ];
      const index = (utcHour + 18) % 24;
      return timezones[timezoneNames[index]];
    }

    /**
     * 
     */
    function getTimeText(time) {
      return `${time.getMonth() + 1}/${time.getDate()}/${time.getFullYear()}`
    }

    /**
     * 
     */
    function generateBarGraph(csv) {
      // Count occurrences of each hour
      const hourCount = Array(24).fill(0);

      csv.forEach((row) => {
        if (row === undefined) {
          return
        }

        const date = new Date(row[0]);
        const hour = date.getUTCHours();
        hourCount[hour]++;
      });

      const max = Math.max(...hourCount)

      const end = (csv[0] || csv[1])[0] || new Date(0)
      const start = (csv[csv.length - 1] || csv[csv.length - 2])[0] || new Date()

      // Generate the bar graph table
      let table = `<h3>Posting Times between ${getTimeText(start)} and ${getTimeText(end)}</h3><p>This shows the frequency of posts, grouped by each hour of the day.<br />The bar with the smallest value is the physical location on earth they are likely to be at.<br />This is because people do not tweet when they sleep, and so the least amount of tweets at that hour is when they sleep, and when they sleep is also where they sleep.</p><table id=\"hours\"><tr id=\"bars\">`;
      for (let i = 0; i < 24; i++) {
        table += `<td><div class="bar" style="height:${hourCount[i] / max * 200}px;"></div></td>`;
      }
      table += "</tr><tr>";
      for (let i = 0; i < 24; i++) {
        table += `<td class="primaryBackground smallText vTop"><center>${i}:00<br/>UTC<div><br/><b>${getSuggestedTimezone(i)}</b></div></center></td>`;
      }
      table += "</tr></table>";

      return table;
    }

    const wordIndex = createIndex(csv)
    const wordIndexKeys = Object.keys(wordIndex)

    /**
     * 
     */
    function replaceWithRegex(inputString, regexPattern, words) {
      return inputString.replace(regexPattern, (match) => {
        //const words = regexPattern.split('|');

      });
    }

    /**
     * 
     */
    function performSearch (value) {
      if (value === '') {
        return
      }

      searchResults.innerHTML = ``

      const candidates = []

      const words = value.trim().toLowerCase().split(/ OR /ig)
      const queryRegex = new RegExp(words.join('|').replace(quotes, ''), 'gi')

      for (query of words) {
        const withoutQuotes = query.replace(quotes, '')
        const indexMatches = wordIndexKeys
          .filter(key => {
            if (query[0] === '"' || query[0] === `'`) {
              return key === withoutQuotes
            } else {
              return key.indexOf(query) === 0  
            }
            
          })
          .map(key => wordIndex[key])

        const tweetIds = [...new Set(indexMatches.flat())]; 

        for (const tweetId of tweetIds) {
          const tweet = csv[tweetId]

          if (tweet === undefined) {
            continue
          }

          const strippedWords = words.map(word => word.replace(quotes, ''))
          candidates.push([
            tweet[0],
            tweet[1]
              .replace(removeUsers, '')
              .replace(removeHash, '')
              .replace(queryRegex, match => {
                const index = strippedWords.indexOf(match);

                if (index >= 0) {
                  return `<span class="highlight">${strippedWords[index]}</span>`;
                }

                return match;                
              })
          ])  
        }
      }

      candidates.sort((a, b) => a[0] - b[0])

      let result = ``
      for (const candidate of candidates) {
        result += `<tr>
        <td>${candidate[0].getFullYear()}</td>
        <td>${candidate[0].getMonth() + 1}</td>
        <td>${candidate[0].getDate()}</td>
        <td>${candidate[0].toLocaleString('en-US', { hour: 'numeric', minute: 'numeric', hour12: true })}</td>
        <td>${candidate[1]}</td>
      </tr>`
      }

      searchResults.innerHTML = `<thead><tr>
        <td>Year</td>
        <td>Month</td>
        <td>Day</td>
        <td>Time</td>
        <td>Text</td>
      </tr></thead><tbody>${result}</tbody>`
    }

    const sleepAnalysis = document.getElementById('sleepAnalysis')
    const barGraphTable = generateBarGraph(csv);
    sleepAnalysis.innerHTML += barGraphTable

    /**
     * Conduct search with each character change
     */
    const searchInput = document.getElementById('search')
    const searchResults = document.getElementById('results')

    searchInput.onkeyup = function search (e) {
      const value = e.target.value.toLowerCase()
      if (value === '') {
        return
      }

      if (searchTimeout) {
        clearTimeout(searchTimeout)
      }

      searchTimeout = setTimeout(() => {
        performSearch(value)
      }, 300)
    }
  </script>
</body>
</html>