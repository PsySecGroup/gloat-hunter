<html>
<head></head>
<body>
  <style>
    table {
      font-family: "Times New Roman", Times, serif;
      border: 1px solid #FFFFFF;
      text-align: center;
      border-collapse: collapse;
    }
    table td, table th {
      border: 1px solid #FFFFFF;
      padding: 3px 2px;
    }
    table tbody td {
      font-size: 15px;
    }
    table tr:nth-child(even) {
      background: #D0E4F5;
    }
    table thead {
      background: #0B6FA4;
      background: -moz-linear-gradient(top, #4893bb 0%, #237dad 66%, #0B6FA4 100%);
      background: -webkit-linear-gradient(top, #4893bb 0%, #237dad 66%, #0B6FA4 100%);
      background: linear-gradient(to bottom, #4893bb 0%, #237dad 66%, #0B6FA4 100%);
      border-bottom: 5px solid #FFFFFF;
    }
    table thead th {
      font-size: 17px;
      font-weight: bold;
      color: #FFFFFF;
      text-align: center;
      border-left: 2px solid #FFFFFF;
    }
    table thead th:first-child {
      border-left: none;
    }

    table tfoot {
      font-size: 14px;
      font-weight: bold;
      color: #333333;
      background: #D0E4F5;
      border-top: 3px solid #444444;
    }
    table tfoot td {
      font-size: 14px;
    }
    .highlight {
      padding: 3px;
      background: yellow;
      font-weight: bold;
      font-style: italic;
      border: #888 solid 1px;
    }
  </style>
  <div>
    <p>Query Options</p>
    <ul>
      <li><b>basket</b> finds anything that starts with "basket" (Like "<b>basket</b>ball and <b>basket</b>weaving)</li>
      <li><b>basket or glove</b> will find anything that starts "basket" or "glove"</li>
      <li><b>"basket"</b> (with quotes) will only find anything that is the word "basket"</li>
    </ul>
    <input id="search" type="text" placeholder="Search here..."/>
    <table id="results"></table>
  </div>
  <script>
    // Create CSV array
    const csv = `
{{replaceMe}}
    `.split('\n').map(line => {
      line = line.trim()
      if (line === '') {
        return
      }

      const parts = line.split('\t')
      return [new Date(parts[0]), parts[1].toLowerCase()]
    })

    let searchTimeout
    const quotes = /'|"/g
    const removeUsers = /\@[^\s\n]+/g
    const removeHash = /\#[^\s\n]+/g

    /**
     * 
     */
    function createIndex (csv) {
      const result = {}
      let i = 0

      for (const tweet of csv) {
        if (tweet === undefined) {
          i += 1
          continue
        }
        const words = tweet[1].split(/\b/)

        // Iterate through each word
        words.forEach(word => {
          if (word.trim() !== '') {
            // Check if word already exists in the index
            if (result[word]) {
              result[word].push(i);
            } else {
              result[word] = [i];
            }
          }
        });

        i += 1
      }

      return result
    }

    const wordIndex = createIndex(csv)
    const wordIndexKeys = Object.keys(wordIndex)

    function replaceWithRegex(inputString, regexPattern, words) {
      return inputString.replace(regexPattern, (match) => {
        //const words = regexPattern.split('|');

      });
    }

    /**
     * 
     */
    function performSearch (value) {
      if (value === '') {
        return
      }

      searchResults.innerHTML = ``

      const candidates = []

      const words = value.trim().toLowerCase().split(/ OR /ig)
      const queryRegex = new RegExp(words.join('|').replace(quotes, ''), 'gi')

      for (query of words) {
        const withoutQuotes = query.replace(quotes, '')
        const indexMatches = wordIndexKeys
          .filter(key => {
            if (query[0] === '"' || query[0] === `'`) {
              return key === withoutQuotes
            } else {
              return key.indexOf(query) === 0  
            }
            
          })
          .map(key => wordIndex[key])

        const tweetIds = [...new Set(indexMatches.flat())]; 

        for (const tweetId of tweetIds) {
          const tweet = csv[tweetId]

          if (tweet === undefined) {
            continue
          }

          const strippedWords = words.map(word => word.replace(quotes, ''))
          candidates.push([
            tweet[0],
            tweet[1]
              .replace(removeUsers, '')
              .replace(removeHash, '')
              .replace(queryRegex, match => {
                const index = strippedWords.indexOf(match);
                console.log({
                  queryRegex, match, strippedWords, index
                })

                if (index >= 0) {
                  return `<span class="highlight">${strippedWords[index]}</span>`;
                }

                return match;                
              })
          ])  
        }
      }

      candidates.sort((a, b) => a[0] - b[0])

      let result = ``
      for (const candidate of candidates) {
        result += `<tr>
        <td>${candidate[0].getFullYear()}</td>
        <td>${candidate[0].getMonth() + 1}</td>
        <td>${candidate[0].getDate()}</td>
        <td>${candidate[0].toLocaleString('en-US', { hour: 'numeric', minute: 'numeric', hour12: true })}</td>
        <td>${candidate[1]}</td>
      </tr>`
      }

      searchResults.innerHTML = `<thead><tr>
        <td>Year</td>
        <td>Month</td>
        <td>Day</td>
        <td>Time</td>
        <td>Text</td>
      </tr></thead><tbody>${result}</tbody>`
    }


    /**
     * Conduct search with each character change
     */
    const searchInput = document.getElementById('search')
    const searchResults = document.getElementById('results')

    searchInput.onkeyup = function search (e) {
      const value = e.target.value.toLowerCase()
      if (value === '') {
        return
      }

      if (searchTimeout) {
        clearTimeout(searchTimeout)
      }

      searchTimeout = setTimeout(() => {
        performSearch(value)
      }, 300)
    }
  </script>
</body>
</html>